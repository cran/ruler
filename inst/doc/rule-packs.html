<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Evgeni Chasnovski" />

<meta name="date" content="2020-03-02" />

<title>Rule Packs</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Rule Packs</h1>
<h4 class="author">Evgeni Chasnovski</h4>
<h4 class="date">2020-03-02</h4>



<p>This vignette describes and explains logic behind common ways of creating rule packs.</p>
<div id="overview" class="section level2">
<h2>Overview</h2>
<p><strong>Rule</strong> is a function which converts data unit of interest (data, group, column, row, cell) to logical value indicating whether this object satisfies certain condition.</p>
<p><strong>Rule pack</strong> is a function which combines several rules for common data unit into one functional block. The recommended way of creating rules is by creating packs right away with the use of <code>dplyr</code> and <a href="http://magrittr.tidyverse.org/">magrittr</a>’s pipe operator.</p>
<p>Some of <code>ruler</code>’s functionality is powered by the <a href="https://echasnovski.github.io/keyholder">keyholder</a> package. It is highly recommended to use its supported functions during rule pack construction. All one- and two-table <code>dplyr</code> verbs applied to local data frames are supported and considered the most appropriate way to create rule packs.</p>
<p>As described in vignette about design process it is necessary for rule pack to have <strong>type</strong> because outputs for different data units have different structure. For this reason <code>ruler</code> has family of <code>*_packs()</code> constructors (where <code>*</code> stands for the name of data unit):</p>
<ul>
<li>They take functions defining packs (in pure form or inside list at any depth) as arguments. It is recommended to name those arguments with future pack names. If no name is supplied then it will be imputed during exposure.</li>
<li>They return list of what should be rule packs of certain type.</li>
</ul>
</div>
<div id="data-rule-packs" class="section level2">
<h2>Data rule packs</h2>
<p>To check whether dimensions of <code>mtcars</code> obey some rules one can write the next dplyr pipeline:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1">mtcars <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarise</span>(</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">  <span class="dt">nrow_low =</span> <span class="kw">nrow</span>(.) <span class="op">&gt;</span><span class="st"> </span><span class="dv">10</span>,</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">  <span class="dt">nrow_high =</span> <span class="kw">nrow</span>(.) <span class="op">&lt;</span><span class="st"> </span><span class="dv">30</span>,</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">  <span class="dt">ncol =</span> <span class="kw">ncol</span>(.) <span class="op">==</span><span class="st"> </span><span class="dv">12</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5">)</a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="co">#&gt;   nrow_low nrow_high  ncol</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="co">#&gt; 1     TRUE     FALSE FALSE</span></a></code></pre></div>
<p>The output has the following structure:</p>
<ul>
<li>Number of rows equals to <strong>one</strong>.</li>
<li>Column names define <strong>rule names</strong>.</li>
<li>Values indicate whether the <strong>data as a whole</strong> follows the rule.</li>
</ul>
<p>There is an easy way to transform this pipeline into a function to be used for any data: <code>mtcars</code> should be replaced with <code>.</code> character. To indicate that this function is a rule pack for data unit ‘data’ it should be wrapped with <code>data_packs()</code>.</p>
<p>The next code creates a list <code>my_data_packs</code> with one data rule pack named <code>my_data_pack_1</code>. That rule pack defines rules with names <code>nrow_low</code>, <code>nrow_high</code>, <code>ncol</code>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">my_data_packs &lt;-<span class="st"> </span><span class="kw">data_packs</span>(</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">  <span class="dt">my_data_pack_1 =</span> . <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarise</span>(</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">    <span class="dt">nrow_low =</span> <span class="kw">nrow</span>(.) <span class="op">&gt;</span><span class="st"> </span><span class="dv">10</span>,</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">    <span class="dt">nrow_high =</span> <span class="kw">nrow</span>(.) <span class="op">&lt;</span><span class="st"> </span><span class="dv">30</span>,</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">    <span class="dt">ncol =</span> <span class="kw">ncol</span>(.) <span class="op">==</span><span class="st"> </span><span class="dv">12</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6">  )</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">)</a></code></pre></div>
</div>
<div id="group-rule-packs" class="section level2">
<h2>Group rule packs</h2>
<p>To check whether certain groups of rows of <code>mtcars</code> obey some rules one can write the next dplyr pipeline:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">mtcars <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(vs, am) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">any_cyl_6 =</span> <span class="kw">any</span>(cyl <span class="op">==</span><span class="st"> </span><span class="dv">6</span>))</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="co">#&gt; # A tibble: 4 x 3</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="co">#&gt; # Groups:   vs [2]</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="co">#&gt;      vs    am any_cyl_6</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;lgl&gt;    </span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="co">#&gt; 1     0     0 FALSE    </span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="co">#&gt; 2     0     1 TRUE     </span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="co">#&gt; 3     1     0 TRUE     </span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="co">#&gt; 4     1     1 FALSE</span></a></code></pre></div>
<p>The output has the following structure:</p>
<ul>
<li>Some columns define group levels (<code>vs</code> and <code>am</code> in this case).</li>
<li>Number of rows equals to <strong>number of validated groups</strong>.</li>
<li>Names of non-grouping columns define <strong>rule names</strong>.</li>
<li>Values indicate whether the <strong>group as a whole</strong> follows the rule.</li>
</ul>
<p>The next code creates a list with one nameless group rule pack (the name will be imputed during exposure). This pack contains one rule <code>any_cyl_6</code> which checks every group defined by <code>vs</code> and <code>am</code> columns.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">my_group_packs &lt;-<span class="st"> </span><span class="kw">group_packs</span>(</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">  . <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(vs, am) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">any_cyl_6 =</span> <span class="kw">any</span>(cyl <span class="op">==</span><span class="st"> </span><span class="dv">6</span>)),</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">  <span class="dt">.group_vars =</span> <span class="kw">c</span>(<span class="st">&quot;vs&quot;</span>, <span class="st">&quot;am&quot;</span>)</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">)</a></code></pre></div>
<p><strong>Notes</strong>:</p>
<ul>
<li>In this example pack’s output is a grouped tibble. It doesn’t affect anything because during exposure this output is <code>ungroup</code>ed.</li>
<li>Names of grouping columns should be supplied with <code>.group_vars</code> argument to distinguish them from non-grouping ones.</li>
<li>Value for <code>var</code> column in validation report is created by <a href="http://tidyr.tidyverse.org/reference/unite.html">uniting</a> them with the default separator <code>.</code>. In this case values will be <code>0.0</code>, <code>0.1</code>, <code>1.0</code>, <code>1.1</code>. To change separator supply it with <code>.group_sep</code> argument.</li>
</ul>
</div>
<div id="column-rule-packs" class="section level2">
<h2>Column rule packs</h2>
<p>To check whether certain columns of <code>mtcars</code> obey some rules one can write the next dplyr pipeline:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">is_integerish &lt;-<span class="st"> </span><span class="cf">function</span>(x) {<span class="kw">all</span>(x <span class="op">==</span><span class="st"> </span><span class="kw">as.integer</span>(x))}</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"></a>
<a class="sourceLine" id="cb5-3" data-line-number="3">mtcars <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="st">  </span><span class="kw">summarise_if</span>(is_integerish, <span class="kw">funs</span>(<span class="dt">mean_low =</span> <span class="kw">mean</span>(.) <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.5</span>))</a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="co">#&gt; Warning: funs() is soft deprecated as of dplyr 0.8.0</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="co">#&gt; Please use a list of either functions or lambdas: </span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8"><span class="co">#&gt;   # Simple named list: </span></a>
<a class="sourceLine" id="cb5-9" data-line-number="9"><span class="co">#&gt;   list(mean = mean, median = median)</span></a>
<a class="sourceLine" id="cb5-10" data-line-number="10"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb5-11" data-line-number="11"><span class="co">#&gt;   # Auto named with `tibble::lst()`: </span></a>
<a class="sourceLine" id="cb5-12" data-line-number="12"><span class="co">#&gt;   tibble::lst(mean, median)</span></a>
<a class="sourceLine" id="cb5-13" data-line-number="13"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb5-14" data-line-number="14"><span class="co">#&gt;   # Using lambdas</span></a>
<a class="sourceLine" id="cb5-15" data-line-number="15"><span class="co">#&gt;   list(~ mean(., trim = .2), ~ median(., na.rm = TRUE))</span></a>
<a class="sourceLine" id="cb5-16" data-line-number="16"><span class="co">#&gt; This warning is displayed once per session.</span></a>
<a class="sourceLine" id="cb5-17" data-line-number="17"><span class="co">#&gt;   cyl_mean_low hp_mean_low vs_mean_low am_mean_low gear_mean_low carb_mean_low</span></a>
<a class="sourceLine" id="cb5-18" data-line-number="18"><span class="co">#&gt; 1         TRUE        TRUE       FALSE       FALSE          TRUE          TRUE</span></a></code></pre></div>
<p>The output has the following structure:</p>
<ul>
<li>Number of rows equals to <strong>one</strong>.</li>
<li>Column names are constructed as <strong>‘validated column name’ + ‘separator’ + ‘rule name’</strong>.</li>
<li>Values indicate whether the <strong>column as a whole</strong> follows the rule.</li>
</ul>
<p>In general it is hard to automatically separate output’s column names into ‘validated column name’ and ‘rule name’ because default separator <code>_</code> is a commonly used one. For this reason <code>ruler</code> has function <code>rules()</code> which wraps <code>funs()</code> with the following functionality:</p>
<ul>
<li>Impute not supplied rule names. The format is ’rule__{ind}’ where {ind} is the index of function position within <code>rules()</code>’s arguments.</li>
<li>Add rarely used prefix <code>._.</code> (Morse code for ‘R’) to rule names. <strong>Note</strong> that one can change this prefix with <code>.prefix</code> argument.</li>
</ul>
<p>The next code creates a list with two elements:</p>
<ul>
<li>A column rule pack <code>my_col_pack_1</code> which checks obedience of ‘integerish’ columns to rule <code>mean_low</code>.</li>
<li>A nameless column rule pack which checks obedience of column <code>vs</code> to some (will be imputed as <code>rule__1</code>) rule. <strong>Note</strong> the use of named argument in <code>vars(vs = &quot;vs&quot;)</code>. This is the current way in <code>dplyr</code>’s scoped variants of <code>summarise</code> and <code>mutate</code> to force using both column and function names in output’s column name.</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">my_col_packs &lt;-<span class="st"> </span><span class="kw">col_packs</span>(</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">  <span class="dt">my_col_pack_1 =</span> . <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarise_if</span>(</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">    is_integerish,</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">    <span class="kw">rules</span>(<span class="dt">mean_low =</span> <span class="kw">mean</span>(.) <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">  ),</a>
<a class="sourceLine" id="cb6-6" data-line-number="6">  . <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarise_at</span>(<span class="kw">vars</span>(<span class="dt">vs =</span> <span class="st">&quot;vs&quot;</span>), <span class="kw">rules</span>(<span class="kw">sum</span>(.) <span class="op">&gt;</span><span class="st"> </span><span class="dv">300</span>))</a>
<a class="sourceLine" id="cb6-7" data-line-number="7">)</a></code></pre></div>
</div>
<div id="row-rule-pack" class="section level2">
<h2>Row rule pack</h2>
<p>To check whether certain rows of <code>mtcars</code> are not outliers one can write the next dplyr pipeline:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">z_score &lt;-<span class="st"> </span><span class="cf">function</span>(x) {(x <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(x)) <span class="op">/</span><span class="st"> </span><span class="kw">sd</span>(x)}</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"></a>
<a class="sourceLine" id="cb7-3" data-line-number="3">mtcars <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">rowMean =</span> <span class="kw">rowMeans</span>(.)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="st">  </span><span class="kw">transmute</span>(<span class="dt">is_common_row_mean =</span> <span class="kw">abs</span>(<span class="kw">z_score</span>(rowMean)) <span class="op">&lt;</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="st">  </span><span class="kw">slice</span>(<span class="dv">10</span><span class="op">:</span><span class="dv">15</span>)</a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="co">#&gt;   is_common_row_mean</span></a>
<a class="sourceLine" id="cb7-8" data-line-number="8"><span class="co">#&gt; 1               TRUE</span></a>
<a class="sourceLine" id="cb7-9" data-line-number="9"><span class="co">#&gt; 2               TRUE</span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10"><span class="co">#&gt; 3               TRUE</span></a>
<a class="sourceLine" id="cb7-11" data-line-number="11"><span class="co">#&gt; 4               TRUE</span></a>
<a class="sourceLine" id="cb7-12" data-line-number="12"><span class="co">#&gt; 5               TRUE</span></a>
<a class="sourceLine" id="cb7-13" data-line-number="13"><span class="co">#&gt; 6              FALSE</span></a></code></pre></div>
<p>The output has the following structure:</p>
<ul>
<li>Number of rows equals to <strong>number of checked rows</strong>.</li>
<li>Column names define <strong>rule names</strong>.</li>
<li>Values indicate whether the <strong>row as a whole</strong> follows the rule.</li>
</ul>
<p>Pipeline like the one above is quite common: for every row compute some value based on all rows and then validate only some of them. However in the validation report column <code>id</code> should represent the row index <em>in the original data frame</em> and this information is missing after applying <code>slice()</code>.</p>
<p>This problem is solved by using <a href="https://echasnovski.github.io/keyholder">keyholder</a> package. Its main purpose is to track information about rows while modifying data frame. During exposure pack is applied to the <strong>keyed</strong> version of input data with key equals to row index. <strong>Note</strong> that to use this feature one should create rule packs using composition of functions supported by <code>keyholder</code>.</p>
<p>The next code creates a list with one row pack <code>my_row_pack_1</code>. It contains one rule <code>is_common_row_mean</code> that checks 6 rows (from 10 to 15) for not being an outlier (based on information from all rows) in terms of row means.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">my_row_packs &lt;-<span class="st"> </span><span class="kw">row_packs</span>(</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">  <span class="dt">my_row_pack_1 =</span> . <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">rowMean =</span> <span class="kw">rowMeans</span>(.)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="st">    </span><span class="kw">transmute</span>(<span class="dt">is_common_row_mean =</span> <span class="kw">abs</span>(<span class="kw">z_score</span>(rowMean)) <span class="op">&lt;</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="st">    </span><span class="kw">slice</span>(<span class="dv">10</span><span class="op">:</span><span class="dv">15</span>)</a>
<a class="sourceLine" id="cb8-5" data-line-number="5">)</a></code></pre></div>
</div>
<div id="cell-rule-pack" class="section level2">
<h2>Cell rule pack</h2>
<p>To check whether certain cells of <code>mtcars</code> are not outliers one can write the next dplyr pipeline:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">mtcars <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">transmute_if</span>(</a>
<a class="sourceLine" id="cb9-2" data-line-number="2">    is_integerish,</a>
<a class="sourceLine" id="cb9-3" data-line-number="3">    <span class="kw">funs</span>(<span class="dt">is_common =</span> <span class="kw">abs</span>(<span class="kw">z_score</span>(.)) <span class="op">&lt;</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb9-4" data-line-number="4">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="st">    </span><span class="kw">slice</span>(<span class="dv">20</span><span class="op">:</span><span class="dv">24</span>)</a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="co">#&gt;   cyl_is_common hp_is_common vs_is_common am_is_common gear_is_common</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="co">#&gt; 1         FALSE        FALSE        FALSE        FALSE           TRUE</span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8"><span class="co">#&gt; 2         FALSE         TRUE        FALSE         TRUE           TRUE</span></a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="co">#&gt; 3         FALSE         TRUE         TRUE         TRUE           TRUE</span></a>
<a class="sourceLine" id="cb9-10" data-line-number="10"><span class="co">#&gt; 4         FALSE         TRUE         TRUE         TRUE           TRUE</span></a>
<a class="sourceLine" id="cb9-11" data-line-number="11"><span class="co">#&gt; 5         FALSE        FALSE         TRUE         TRUE           TRUE</span></a>
<a class="sourceLine" id="cb9-12" data-line-number="12"><span class="co">#&gt;   carb_is_common</span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13"><span class="co">#&gt; 1          FALSE</span></a>
<a class="sourceLine" id="cb9-14" data-line-number="14"><span class="co">#&gt; 2          FALSE</span></a>
<a class="sourceLine" id="cb9-15" data-line-number="15"><span class="co">#&gt; 3           TRUE</span></a>
<a class="sourceLine" id="cb9-16" data-line-number="16"><span class="co">#&gt; 4           TRUE</span></a>
<a class="sourceLine" id="cb9-17" data-line-number="17"><span class="co">#&gt; 5           TRUE</span></a></code></pre></div>
<p>The output has the following structure:</p>
<ul>
<li>Number of rows equals to <strong>number of rows for checked cells</strong>.</li>
<li>Column names are constructed as <strong>‘validated column name’ + ‘separator’ + ‘rule name’</strong>.</li>
<li>Values indicate whether the <strong>cell</strong> follows the rule.</li>
</ul>
<p>Basically cell rule pack is a combination of column and row rule packs. It means:</p>
<ul>
<li>Using <code>rules()</code> instead of <code>funs()</code> in scoped variants of <code>transmute()</code>.</li>
<li>Using functions supported by <code>keyholder</code>.</li>
</ul>
<p>The next code creates a list with one cell pack <code>my_cell_pack_1</code>. It checks cells of every integer-like column in rows 20-24 for not being an outlier within column.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">my_cell_packs &lt;-<span class="st"> </span><span class="kw">cell_packs</span>(</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">  <span class="dt">my_cell_pack_1 =</span> . <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">transmute_if</span>(</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">    is_integerish,</a>
<a class="sourceLine" id="cb10-4" data-line-number="4">    <span class="kw">rules</span>(<span class="dt">is_common =</span> <span class="kw">abs</span>(<span class="kw">z_score</span>(.)) <span class="op">&lt;</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb10-5" data-line-number="5">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="st">    </span><span class="kw">slice</span>(<span class="dv">20</span><span class="op">:</span><span class="dv">24</span>)</a>
<a class="sourceLine" id="cb10-7" data-line-number="7">)</a></code></pre></div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
