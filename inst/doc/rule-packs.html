<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Evgeni Chasnovski" />

<meta name="date" content="2023-03-28" />

<title>Rule Packs</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Rule Packs</h1>
<h4 class="author">Evgeni Chasnovski</h4>
<h4 class="date">2023-03-28</h4>



<p>This vignette describes and explains logic behind common ways of
creating rule packs.</p>
<div id="overview" class="section level2">
<h2>Overview</h2>
<p><strong>Rule</strong> is a function which converts data unit of
interest (data, group, column, row, cell) to logical value indicating
whether this object satisfies certain condition.</p>
<p><strong>Rule pack</strong> is a function which combines several rules
for common data unit into one functional block. The recommended way of
creating rules is by creating packs right away with the use of
<code>dplyr</code> and <a href="https://magrittr.tidyverse.org/">magrittr</a>’s pipe operator.</p>
<p>Some of <code>ruler</code>’s functionality is powered by the <a href="https://echasnovski.github.io/keyholder/">keyholder</a> package.
It is highly recommended to use its supported functions during rule pack
construction. All one- and two-table <code>dplyr</code> verbs applied to
local data frames are supported and considered the most appropriate way
to create rule packs.</p>
<p>As described in vignette about design process it is necessary for
rule pack to have <strong>type</strong> because outputs for different
data units have different structure. For this reason <code>ruler</code>
has family of <code>*_packs()</code> constructors (where <code>*</code>
stands for the name of data unit):</p>
<ul>
<li>They take functions defining packs (in pure form or inside list at
any depth) as arguments. It is recommended to name those arguments with
future pack names. If no name is supplied then it will be imputed during
exposure.</li>
<li>They return list of what should be rule packs of certain type.</li>
</ul>
</div>
<div id="data-rule-packs" class="section level2">
<h2>Data rule packs</h2>
<p>To check whether dimensions of <code>mtcars</code> obey some rules
one can write the next dplyr pipeline:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>mtcars <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>  <span class="at">nrow_low =</span> <span class="fu">nrow</span>(.) <span class="sc">&gt;</span> <span class="dv">10</span>,</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>  <span class="at">nrow_high =</span> <span class="fu">nrow</span>(.) <span class="sc">&lt;</span> <span class="dv">30</span>,</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>  <span class="at">ncol =</span> <span class="fu">ncol</span>(.) <span class="sc">==</span> <span class="dv">12</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>)</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="co">#&gt;   nrow_low nrow_high  ncol</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="co">#&gt; 1     TRUE     FALSE FALSE</span></span></code></pre></div>
<p>The output has the following structure:</p>
<ul>
<li>Number of rows equals to <strong>one</strong>.</li>
<li>Column names define <strong>rule names</strong>.</li>
<li>Values indicate whether the <strong>data as a whole</strong> follows
the rule.</li>
</ul>
<p>There is an easy way to transform this pipeline into a function to be
used for any data: <code>mtcars</code> should be replaced with
<code>.</code> character. To indicate that this function is a rule pack
for data unit ‘data’ it should be wrapped with
<code>data_packs()</code>.</p>
<p>The next code creates a list <code>my_data_packs</code> with one data
rule pack named <code>my_data_pack_1</code>. That rule pack defines
rules with names <code>nrow_low</code>, <code>nrow_high</code>,
<code>ncol</code>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>my_data_packs <span class="ot">&lt;-</span> <span class="fu">data_packs</span>(</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>  <span class="at">my_data_pack_1 =</span> . <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>    <span class="at">nrow_low =</span> <span class="fu">nrow</span>(.) <span class="sc">&gt;</span> <span class="dv">10</span>,</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>    <span class="at">nrow_high =</span> <span class="fu">nrow</span>(.) <span class="sc">&lt;</span> <span class="dv">30</span>,</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>    <span class="at">ncol =</span> <span class="fu">ncol</span>(.) <span class="sc">==</span> <span class="dv">12</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>  )</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="group-rule-packs" class="section level2">
<h2>Group rule packs</h2>
<p>To check whether certain groups of rows of <code>mtcars</code> obey
some rules one can write the next dplyr pipeline:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>mtcars <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(vs, am) <span class="sc">%&gt;%</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">any_cyl_6 =</span> <span class="fu">any</span>(cyl <span class="sc">==</span> <span class="dv">6</span>))</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="co">#&gt; `summarise()` has grouped output by &#39;vs&#39;. You can override using the `.groups`</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="co">#&gt; argument.</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="co">#&gt; # A tibble: 4 × 3</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="co">#&gt; # Groups:   vs [2]</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="co">#&gt;      vs    am any_cyl_6</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;lgl&gt;    </span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a><span class="co">#&gt; 1     0     0 FALSE    </span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a><span class="co">#&gt; 2     0     1 TRUE     </span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a><span class="co">#&gt; 3     1     0 TRUE     </span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a><span class="co">#&gt; 4     1     1 FALSE</span></span></code></pre></div>
<p>The output has the following structure:</p>
<ul>
<li>Some columns define group levels (<code>vs</code> and
<code>am</code> in this case).</li>
<li>Number of rows equals to <strong>number of validated
groups</strong>.</li>
<li>Names of non-grouping columns define <strong>rule
names</strong>.</li>
<li>Values indicate whether the <strong>group as a whole</strong>
follows the rule.</li>
</ul>
<p>The next code creates a list with one nameless group rule pack (the
name will be imputed during exposure). This pack contains one rule
<code>any_cyl_6</code> which checks every group defined by
<code>vs</code> and <code>am</code> columns.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>my_group_packs <span class="ot">&lt;-</span> <span class="fu">group_packs</span>(</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>  . <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(vs, am) <span class="sc">%&gt;%</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">any_cyl_6 =</span> <span class="fu">any</span>(cyl <span class="sc">==</span> <span class="dv">6</span>)),</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>  <span class="at">.group_vars =</span> <span class="fu">c</span>(<span class="st">&quot;vs&quot;</span>, <span class="st">&quot;am&quot;</span>)</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>)</span></code></pre></div>
<p><strong>Notes</strong>:</p>
<ul>
<li>In this example pack’s output is a grouped tibble. It doesn’t affect
anything because during exposure this output is
<code>ungroup</code>ed.</li>
<li>Names of grouping columns should be supplied with
<code>.group_vars</code> argument to distinguish them from non-grouping
ones.</li>
<li>Value for <code>var</code> column in validation report is created by
<a href="https://tidyr.tidyverse.org/reference/unite.html">uniting</a>
them with the default separator <code>.</code>. In this case values will
be <code>0.0</code>, <code>0.1</code>, <code>1.0</code>,
<code>1.1</code>. To change separator supply it with
<code>.group_sep</code> argument.</li>
</ul>
</div>
<div id="column-rule-packs" class="section level2">
<h2>Column rule packs</h2>
<p>To check whether certain columns of <code>mtcars</code> obey some
rules one can write the next dplyr pipeline:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>is_integerish <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>  <span class="fu">all</span>(x <span class="sc">==</span> <span class="fu">as.integer</span>(x))</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>}</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>mtcars <span class="sc">%&gt;%</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>  <span class="fu">summarise_if</span>(is_integerish, <span class="fu">list</span>(<span class="at">mean_low =</span> <span class="sc">~</span> <span class="fu">mean</span>(.) <span class="sc">&gt;</span> <span class="fl">0.5</span>))</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="co">#&gt;   cyl_mean_low hp_mean_low vs_mean_low am_mean_low gear_mean_low carb_mean_low</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a><span class="co">#&gt; 1         TRUE        TRUE       FALSE       FALSE          TRUE          TRUE</span></span></code></pre></div>
<p>The output has the following structure:</p>
<ul>
<li>Number of rows equals to <strong>one</strong>.</li>
<li>Column names are constructed as <strong>‘validated column name’ +
‘separator’ + ‘rule name’</strong>.</li>
<li>Values indicate whether the <strong>column as a whole</strong>
follows the rule.</li>
</ul>
<p>In general it is hard to automatically separate output’s column names
into ‘validated column name’ and ‘rule name’ because default separator
<code>_</code> is a commonly used one. For this reason
<code>ruler</code> has function <code>rules()</code> with the following
functionality:</p>
<ul>
<li>Impute not supplied rule names. The format is ’rule__{ind}’ where
{ind} is the index of function position within <code>rules()</code>’s
arguments.</li>
<li>Add rarely used prefix <code>._.</code> (Morse code for ‘R’) to rule
names. <strong>Note</strong> that one can change this prefix with
<code>.prefix</code> argument.</li>
</ul>
<p>The next code creates a list with two elements:</p>
<ul>
<li>A column rule pack <code>my_col_pack_1</code> which checks obedience
of ‘integerish’ columns to rule <code>mean_low</code>.</li>
<li>A nameless column rule pack which checks obedience of column
<code>vs</code> to some (will be imputed as <code>rule__1</code>) rule.
<strong>Note</strong> the use of named argument in
<code>vars(vs = &quot;vs&quot;)</code>. This is the current way in
<code>dplyr</code>’s scoped variants of <code>summarise</code> and
<code>mutate</code> to force using both column and function names in
output’s column name.</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>my_col_packs <span class="ot">&lt;-</span> <span class="fu">col_packs</span>(</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>  <span class="at">my_col_pack_1 =</span> . <span class="sc">%&gt;%</span> <span class="fu">summarise_if</span>(</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>    is_integerish,</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>    <span class="fu">rules</span>(<span class="at">mean_low =</span> <span class="fu">mean</span>(.) <span class="sc">&gt;</span> <span class="fl">0.5</span>)</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>  ),</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>  . <span class="sc">%&gt;%</span> <span class="fu">summarise_at</span>(<span class="fu">vars</span>(<span class="at">vs =</span> <span class="st">&quot;vs&quot;</span>), <span class="fu">rules</span>(<span class="fu">sum</span>(.) <span class="sc">&gt;</span> <span class="dv">300</span>))</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="row-rule-pack" class="section level2">
<h2>Row rule pack</h2>
<p>To check whether certain rows of <code>mtcars</code> are not outliers
one can write the next dplyr pipeline:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>z_score <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>  (x <span class="sc">-</span> <span class="fu">mean</span>(x)) <span class="sc">/</span> <span class="fu">sd</span>(x)</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>}</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>mtcars <span class="sc">%&gt;%</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rowMean =</span> <span class="fu">rowMeans</span>(.)) <span class="sc">%&gt;%</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>  <span class="fu">transmute</span>(<span class="at">is_common_row_mean =</span> <span class="fu">abs</span>(<span class="fu">z_score</span>(rowMean)) <span class="sc">&lt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">10</span><span class="sc">:</span><span class="dv">15</span>)</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a><span class="co">#&gt;                    is_common_row_mean</span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a><span class="co">#&gt; Merc 280                         TRUE</span></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a><span class="co">#&gt; Merc 280C                        TRUE</span></span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a><span class="co">#&gt; Merc 450SE                       TRUE</span></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a><span class="co">#&gt; Merc 450SL                       TRUE</span></span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a><span class="co">#&gt; Merc 450SLC                      TRUE</span></span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a><span class="co">#&gt; Cadillac Fleetwood              FALSE</span></span></code></pre></div>
<p>The output has the following structure:</p>
<ul>
<li>Number of rows equals to <strong>number of checked
rows</strong>.</li>
<li>Column names define <strong>rule names</strong>.</li>
<li>Values indicate whether the <strong>row as a whole</strong> follows
the rule.</li>
</ul>
<p>Pipeline like the one above is quite common: for every row compute
some value based on all rows and then validate only some of them.
However in the validation report column <code>id</code> should represent
the row index <em>in the original data frame</em> and this information
is missing after applying <code>slice()</code>.</p>
<p>This problem is solved by using <a href="https://echasnovski.github.io/keyholder/">keyholder</a> package.
Its main purpose is to track information about rows while modifying data
frame. During exposure pack is applied to the <strong>keyed</strong>
version of input data with key equals to row index.
<strong>Note</strong> that to use this feature one should create rule
packs using composition of functions supported by
<code>keyholder</code>.</p>
<p>The next code creates a list with one row pack
<code>my_row_pack_1</code>. It contains one rule
<code>is_common_row_mean</code> that checks 6 rows (from 10 to 15) for
not being an outlier (based on information from all rows) in terms of
row means.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>my_row_packs <span class="ot">&lt;-</span> <span class="fu">row_packs</span>(</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>  <span class="at">my_row_pack_1 =</span> . <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">rowMean =</span> <span class="fu">rowMeans</span>(.)) <span class="sc">%&gt;%</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>    <span class="fu">transmute</span>(<span class="at">is_common_row_mean =</span> <span class="fu">abs</span>(<span class="fu">z_score</span>(rowMean)) <span class="sc">&lt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">10</span><span class="sc">:</span><span class="dv">15</span>)</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="cell-rule-pack" class="section level2">
<h2>Cell rule pack</h2>
<p>To check whether certain cells of <code>mtcars</code> are not
outliers one can write the next dplyr pipeline:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>mtcars <span class="sc">%&gt;%</span> <span class="fu">transmute_if</span>(</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>  is_integerish,</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">is_common =</span> <span class="sc">~</span> <span class="fu">abs</span>(<span class="fu">z_score</span>(.)) <span class="sc">&lt;</span> <span class="dv">1</span>)</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">20</span><span class="sc">:</span><span class="dv">24</span>)</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="co">#&gt;                  cyl_is_common hp_is_common vs_is_common am_is_common</span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a><span class="co">#&gt; Toyota Corolla           FALSE        FALSE        FALSE        FALSE</span></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a><span class="co">#&gt; Toyota Corona            FALSE         TRUE        FALSE         TRUE</span></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a><span class="co">#&gt; Dodge Challenger         FALSE         TRUE         TRUE         TRUE</span></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a><span class="co">#&gt; AMC Javelin              FALSE         TRUE         TRUE         TRUE</span></span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a><span class="co">#&gt; Camaro Z28               FALSE        FALSE         TRUE         TRUE</span></span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a><span class="co">#&gt;                  gear_is_common carb_is_common</span></span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a><span class="co">#&gt; Toyota Corolla             TRUE          FALSE</span></span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a><span class="co">#&gt; Toyota Corona              TRUE          FALSE</span></span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a><span class="co">#&gt; Dodge Challenger           TRUE           TRUE</span></span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a><span class="co">#&gt; AMC Javelin                TRUE           TRUE</span></span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a><span class="co">#&gt; Camaro Z28                 TRUE           TRUE</span></span></code></pre></div>
<p>The output has the following structure:</p>
<ul>
<li>Number of rows equals to <strong>number of rows for checked
cells</strong>.</li>
<li>Column names are constructed as <strong>‘validated column name’ +
‘separator’ + ‘rule name’</strong>.</li>
<li>Values indicate whether the <strong>cell</strong> follows the
rule.</li>
</ul>
<p>Basically cell rule pack is a combination of column and row rule
packs. It means:</p>
<ul>
<li>Using <code>rules()</code> instead of pure list in scoped variants
of <code>transmute()</code>.</li>
<li>Using functions supported by <code>keyholder</code>.</li>
</ul>
<p>The next code creates a list with one cell pack
<code>my_cell_pack_1</code>. It checks cells of every integer-like
column in rows 20-24 for not being an outlier within column.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>my_cell_packs <span class="ot">&lt;-</span> <span class="fu">cell_packs</span>(</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>  <span class="at">my_cell_pack_1 =</span> . <span class="sc">%&gt;%</span> <span class="fu">transmute_if</span>(</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>    is_integerish,</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>    <span class="fu">rules</span>(<span class="at">is_common =</span> <span class="fu">abs</span>(<span class="fu">z_score</span>(.)) <span class="sc">&lt;</span> <span class="dv">1</span>)</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">20</span><span class="sc">:</span><span class="dv">24</span>)</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>)</span></code></pre></div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
